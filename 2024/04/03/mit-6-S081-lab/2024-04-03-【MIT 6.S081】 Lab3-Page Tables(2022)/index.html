<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>ã€MIT 6.S081ã€‘ Lab3-Page Tables(2022) | Devil</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ã€MIT 6.S081ã€‘ Lab3-Page Tables(2022)</h1><a id="logo" href="/.">Devil</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ã€MIT 6.S081ã€‘ Lab3-Page Tables(2022)</h1><div class="post-meta">2024-04-03<span> | </span><span class="category"><a href="/categories/OS/">OS</a><a href="/categories/OS/MIT-6-S081/">MIT 6.S081</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">å®éªŒæ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Speed-up-system-calls-easy"><span class="toc-number">2.</span> <span class="toc-text">Speed up system callsÂ (easy)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD"><span class="toc-number">2.1.</span> <span class="toc-text">å…·ä½“å®æ–½</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-1%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%8C%87%E9%92%88"><span class="toc-number">2.1.1.</span> <span class="toc-text">Step 1ï¼šåˆ›å»ºæŒ‡é’ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-2%EF%BC%9Aallocate"><span class="toc-number">2.1.2.</span> <span class="toc-text">Step 2ï¼šallocate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-3%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="toc-number">2.1.3.</span> <span class="toc-text">Step 3ï¼šåˆ›å»ºæ˜ å°„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-4%EF%BC%9A%E6%B8%85%E9%99%A4"><span class="toc-number">2.1.4.</span> <span class="toc-text">Step 4ï¼šæ¸…é™¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">2.2.</span> <span class="toc-text">è¿è¡Œç»“æœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">2.3.</span> <span class="toc-text">æ³¨æ„</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Print-a-page-table-easy"><span class="toc-number">3.</span> <span class="toc-text">Print a page tableÂ (easy)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text">å‡†å¤‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD-1"><span class="toc-number">3.2.</span> <span class="toc-text">å…·ä½“å®æ–½</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-1-%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%A3%B0%E6%98%8E%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.1.</span> <span class="toc-text">Step 1: åˆ›å»ºå¹¶å£°æ˜å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-2-%E5%AE%9E%E7%8E%B0%E5%85%B7%E4%BD%93%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.2.</span> <span class="toc-text">Step 2: å®ç°å…·ä½“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-3%EF%BC%9A%E8%BE%93%E5%87%BA%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B%E9%A1%B5%E8%A1%A8"><span class="toc-number">3.2.3.</span> <span class="toc-text">Step 3ï¼šè¾“å‡ºå¯åŠ¨è¿›ç¨‹é¡µè¡¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-1"><span class="toc-number">3.3.</span> <span class="toc-text">è¿è¡Œç»“æœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F-1"><span class="toc-number">3.4.</span> <span class="toc-text">æ³¨æ„</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Detecting-which-pages-have-been-accessed-hard"><span class="toc-number">4.</span> <span class="toc-text">Detecting which pages have been accessed (hard)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-1"><span class="toc-number">4.1.</span> <span class="toc-text">å‡†å¤‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Walk-%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.1.</span> <span class="toc-text">Walk å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Argint-%E5%92%8C-Argaddr-%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">Argint å’Œ Argaddr å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Copyin-%E5%92%8C-Copyout-%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.3.</span> <span class="toc-text">Copyin å’Œ Copyout å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD-2"><span class="toc-number">4.2.</span> <span class="toc-text">å…·ä½“å®æ–½</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-1%EF%BC%9A%E6%B7%BB%E5%8A%A0-PTE-A"><span class="toc-number">4.2.1.</span> <span class="toc-text">Step 1ï¼šæ·»åŠ  PTE_A</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step-2%EF%BC%9A%E5%AE%8C%E5%96%84%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">Step 2ï¼šå®Œå–„å†…æ ¸ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-2"><span class="toc-number">4.3.</span> <span class="toc-text">è¿è¡Œç»“æœ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>è¯¾ç¨‹åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2022/schedule.html">https://pdos.csail.mit.edu/6.S081/2022/schedule.html</a><br>Lab åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2022/labs/pgtbl.html">https://pdos.csail.mit.edu/6.S081/2022/labs/pgtbl.html</a><br>æˆ‘çš„ä»£ç åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/devilran6/devilran-xv6/tree/pgtbl">https://github.com/devilran6/devilran-xv6/tree/pgtbl</a><br>Commitsï¼š<a target="_blank" rel="noopener" href="https://github.com/devilran6/devilran-xv6/commits/pgtbl/">https://github.com/devilran6/devilran-xv6/commits/pgtbl/</a></p>
</blockquote>
<h2 id="å®éªŒæ€»ç»“"><a href="#å®éªŒæ€»ç»“" class="headerlink" title="å®éªŒæ€»ç»“"></a>å®éªŒæ€»ç»“</h2><p>Lab 3 å®Œæˆæ—¶é—´çº¦ 10 h</p>
<p><strong>ä¸€äº›å¤±è¯¯</strong></p>
<p>ä¸ºä»€ä¹ˆä» lab 3 çš„é¢˜ç›®ä¸Šæˆ‘ç‰¹æ„å†™äº† 2022 å‘¢ï¼Ÿ<br>æ˜¯å› ä¸ºæˆ‘ä¹‹å‰å› ä¸º 2020 ç‰ˆæœ¬çš„ä»£ç ç¼–è¯‘ä¸æˆåŠŸï¼Œæ‰€ä»¥ä¸€ç›´ç”¨çš„æ˜¯ 2022 ç‰ˆæœ¬çš„ä»£ç ã€‚<br>ä½†æ˜¯æˆ‘ä¸€ç›´æ˜¯æŒ‰ç…§ 2020 ç‰ˆæœ¬çš„å®éªŒåšçš„ï¼Œå¯¼è‡´å®éªŒä¸€ç›´å¡ä¸»ğŸ˜­ğŸ˜­ğŸ˜­</p>
<p><strong>Lab 3-1 Speed up system callsÂ (easy)</strong></p>
<p>é€šè¿‡å®ç°ä¸€ä¸ªç”¨æˆ·æ€å’Œå†…æ ¸æ€éƒ½èƒ½è®¿é—®çš„ç©ºé—´ï¼Œè¿›è€Œå°†ä¸€äº›å†…æ ¸æ•°æ®ä¿å­˜åœ¨æ­¤å¤„ï¼Œä»è€Œä½¿å¾—ä¸€äº›æ“ä½œä¸ç”¨è¿›è¡Œç”¨æˆ·å†…æ ¸çš„åˆ‡æ¢ï¼Œè¿›è¡ŒåŠ é€Ÿã€‚</p>
<p>è¿™ä¸ªå®éªŒèƒ½æ„Ÿå—åˆ°é€šè¿‡â€ç©ºé—´æ¢æ—¶é—´â€çš„å° trick æ¥å‡å°‘é‡å¤çš„ä¸å¿…è¦æ“ä½œï¼Œå®ç°æ“ä½œç³»ç»Ÿçš„åŠ é€Ÿä¸­çš„ç²¾å¦™!!</p>
<p><strong>Lab 3-2 Print a page tableÂ (easy)</strong></p>
<p>å®ç°ä¸€ä¸ªè¾“å‡ºé¡µè¡¨çš„å‡½æ•°ã€‚</p>
<p>è¿™ä¸ªå®éªŒä¸æ˜¯å¾ˆéš¾ï¼Œå‚è€ƒ <code>freewalk</code> å‡½æ•°å°±å¾ˆå¥½å†™å•¦</p>
<p>ä¸»è¦çš„ç‚¹åœ¨äºï¼š</p>
<ul>
<li>PTE çš„ä¸‰çº§é¡µè¡¨æœºåˆ¶</li>
<li>å¦‚ä½•é€šè¿‡æƒé™ä½åŒºåˆ†æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹</li>
</ul>
<p><strong>Lab 3-3 Detecting which pages have been accessed (hard)</strong></p>
<p>å®ç°æŸ¥çœ‹ä¸€æ®µé¡µè¡¨æ˜¯å¦è¢«è®¿é—®è¿‡çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>è¿™ä¸ªå®éªŒä¸éœ€è¦åœ¨å¾ˆå¤šä¸ªåœ°æ–¹è¿›è¡Œä»£ç æ“ä½œï¼Œåªéœ€è¦åœ¨å†…æ ¸ç³»ç»Ÿè°ƒç”¨å‡½æ•°å¤„è¿›è¡Œæ·»åŠ ä»£ç ã€‚<br>å¾ˆå¥½çš„å®ç°äº†ï¼Œåªç»™ä½ æ¥å£ï¼Œå…·ä½“å®ç°ä»£ç è‡ªè¡Œéšæ„çš„ç†å¿µ!!</p>
<p>ä¸»è¦æ˜¯è¦äº†è§£å†…æ ¸å’Œç”¨æˆ·ä¹‹é—´æ•°æ®æ˜¯å¦‚ä½•ä¼ é€’çš„ â€“ éœ€è¦ç”¨è¿‡ <code>argint</code> <code>argaddr</code> <code>copyin</code> <code>copyout</code> ç­‰å‡½æ•°è¿›è¡Œä¼ é€’<br>ä¼ é€’å¦‚æ­¤å¤æ‚çš„åŸå› æ˜¯ï¼Œå†…æ ¸å’Œç”¨æˆ·ä¹‹é—´è¿›è¡Œçš„å¼ºéš”ç¦»!!</p>
<h2 id="Speed-up-system-calls-easy"><a href="#Speed-up-system-calls-easy" class="headerlink" title="Speed up system callsÂ (easy)"></a>Speed up system callsÂ (easy)</h2><p>æ“ä½œç³»ç»Ÿé€šè¿‡å°† user å’Œ kernel ä¸­çš„åªè¯»æ•°æ®å˜æˆå…±äº«æ•°æ®ï¼Œè¿™æ ·å°†ä¼šæ¶ˆé™¤æ‰§è¡Œè¿™äº›ç³»ç»Ÿè°ƒç”¨æ—¶çš„å†…æ ¸äº¤å‰çš„éœ€è¦ï¼Œæ­¤ä»»åŠ¡å°†ä¼˜åŒ– xv6 ä¸­çš„ <code>ugetpid()</code> ã€‚</p>
<blockquote>
<p>When each process is created, map one read-only page at <code>USYSCALL</code> (a virtual address defined inÂ memlayout.h). </p>
<p>At the start of this page, store aÂ struct usyscallÂ (also defined inÂ memlayout.h), and initialize it to store the PID of the current process. </p>
<p>For this lab,Â ugetpid()Â has been provided on the userspace side and will automatically use the USYSCALL mapping. </p>
<p>You will receive full credit for this part of the lab if theÂ ugetpidÂ test case passes when runningÂ pgtbltest.</p>
</blockquote>
<p>å…³äº <code>memlayout.h</code></p>
<p><img src="/../../assets/image-20240402184551330.png" alt="|500"></p>
<h3 id="å…·ä½“å®æ–½"><a href="#å…·ä½“å®æ–½" class="headerlink" title="å…·ä½“å®æ–½"></a>å…·ä½“å®æ–½</h3><h4 id="Step-1ï¼šåˆ›å»ºæŒ‡é’ˆ"><a href="#Step-1ï¼šåˆ›å»ºæŒ‡é’ˆ" class="headerlink" title="Step 1ï¼šåˆ›å»ºæŒ‡é’ˆ"></a>Step 1ï¼šåˆ›å»ºæŒ‡é’ˆ</h4><p>é¦–å…ˆåœ¨ <code>proc.h</code> ä¸­çš„ <code>PCB</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>usyscall</code> çš„æŒ‡é’ˆ</p>
<p><img src="/../../assets/image-20240402143659816.png"></p>
<h4 id="Step-2ï¼šallocate"><a href="#Step-2ï¼šallocate" class="headerlink" title="Step 2ï¼šallocate"></a>Step 2ï¼šallocate</h4><p>åœ¨ <code>proc.c</code> ä¸­çš„ <code>allocproc()</code> ç»™ <code>p-&gt;usyscall</code> æŒ‡é’ˆåˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œå¹¶å°† <code>pid</code> çš„å€¼æ”¾è¿›å»</p>
<p><img src="/../../assets/image-20240402184639767.png"></p>
<h4 id="Step-3ï¼šåˆ›å»ºæ˜ å°„"><a href="#Step-3ï¼šåˆ›å»ºæ˜ å°„" class="headerlink" title="Step 3ï¼šåˆ›å»ºæ˜ å°„"></a>Step 3ï¼šåˆ›å»ºæ˜ å°„</h4><p><del>åœ¨ <code>memlayout.h</code> ä¸­æ·»åŠ  <code>#define LAB_PGTBL</code>ï¼ˆæ„Ÿè§‰è¿™é‡Œåº”è¯¥æ·»åŠ åœ¨ <code>defs.h</code> ä¸­ï¼Œä½†æ˜¯ kæ·»åŠ äº†æ²¡ä½œç”¨ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</del></p>
<p>åœ¨ Makefile ä¸­å·²ç»æ·»åŠ å¥½äº† <code>-DLAB_PGTBL</code> ç¼–è¯‘é€‰é¡¹ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦æ·»åŠ ï¼Œæœ€å¼€å§‹æ²¡æ˜¾ç¤ºæ˜¯å› ä¸º vscode ä¸ä¼šæ˜¾ç¤ºå‡º Makefile ä¸­çš„å®<br><img src="/../../assets/image-20240402143023943.png"></p>
<p>åœ¨ <code>proc.c</code> ä¸­çš„ <code>proc_pagetable()</code> é‡Œé¢é€šè¿‡ <code>mappages()</code> æ·»åŠ æ˜ å°„<br>!! æ³¨æ„æƒé™è¦æœ‰ <code>PTE_U</code> è¡¨ç¤ºåœ¨ç”¨æˆ·æ€å¯ä»¥è®¿é—®</p>
<p><img src="/../../assets/image-20240402144734389.png"></p>
<h4 id="Step-4ï¼šæ¸…é™¤"><a href="#Step-4ï¼šæ¸…é™¤" class="headerlink" title="Step 4ï¼šæ¸…é™¤"></a>Step 4ï¼šæ¸…é™¤</h4><p>åœ¨ <code>proc.c</code> ä¸­<br>åˆ†åˆ«åœ¨ <code>proc_freepagetable()</code> å’Œ <code>freeproc()</code> ä¸­æ¸…é™¤æ˜ å°„å’Œ <code>p-&gt;usyscall</code></p>
<p><img src="/../../assets/image-20240402145120732.png"></p>
<p><img src="/../../assets/image-20240402185002485.png"></p>
<h3 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p><img src="/../../assets/image-20240402185508366.png"></p>
<h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>åœ¨ <code>allocproc()</code> ä¸­æ·»åŠ çš„ä»£ç åˆ†é… <code>usyscall</code> é¡µé¢å¦‚æœæ”¾åˆ°åˆ†é… <code>user page table</code> åé¢çš„è¯ï¼Œä¼šå‡ºç°å†…å­˜é—®é¢˜</p>
<blockquote>
<p>ä½†è¿˜æ²¡æƒ³æ˜ç™½ä¸ºä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<p><img src="/../../assets/image-20240402184338465.png"></p>
<h2 id="Print-a-page-table-easy"><a href="#Print-a-page-table-easy" class="headerlink" title="Print a page tableÂ (easy)"></a>Print a page tableÂ (easy)</h2><blockquote>
<p>Define a function calledÂ <code>vmprint()</code>. </p>
<p>It should take aÂ <code>pagetable_t</code>Â argument, and print that pagetable in the format described below. </p>
<p>InsertÂ <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code>Â in <code>exec.c</code> just before theÂ return argc, to print the first processâ€™s page table. </p>
<p>You receive full credit for this part of the lab if you pass theÂ pte printoutÂ test ofÂ make grade.</p>
</blockquote>
<p>å®ç°ä¸€ä¸ªå¯è§†åŒ–é¡µè¡¨çš„å‡½æ•°ï¼Œæ•ˆæœå¦‚ä¸‹</p>
<p><img src="/../../assets/image-20240402191422805.png"></p>
<ul>
<li>Hint<ul>
<li>åœ¨ <code>kernel/vm.c</code> ä¸­åˆ›å»º <code>vmprint()</code></li>
<li>ä½¿ç”¨åœ¨ <code>kernel/riscv.h</code> ä¸­æœ€åº•éƒ¨çš„ä¸€äº› macro</li>
<li>ä» <code>freewalk</code> ä¸­è·å¾—ä¸€äº›å¯å‘</li>
<li>åœ¨ <code>kernel/defs.h</code> ä¸­å£°æ˜ <code>vmprint()</code>ï¼Œä»è€Œ <code>exec.c</code> å‡½æ•°ä¸­å¯ä»¥å¯¹å…¶è°ƒç”¨</li>
<li>ç”¨ <code>%p</code> æ¥è¾“å‡º 64 bits çš„ PTE</li>
</ul>
</li>
</ul>
<h3 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h3><p>åœ¨ <code>riscv.h</code> ä¸­å£°æ˜çš„ä¸€äº›å®</p>
<p><img src="/../../assets/image-20240402191704442.png"></p>
<p><code>freewalk</code> å‡½æ•°<br>æ³¨æ„å†™çš„æ³¨é‡Šï¼Œä½¿ç”¨ <code>freewalk</code> å‰ï¼Œéœ€è¦å…ˆå°†å¶å­èŠ‚ç‚¹è¿›è¡Œé‡Šæ”¾ã€‚<br>ä»ä»£ç ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¯¹å¶å­èŠ‚ç‚¹æ²¡æœ‰æ“ä½œï¼ˆå°±æ²¡æœ‰å¶å­èŠ‚ç‚¹éƒ¨åˆ†çš„ <code>if</code> åˆ†æ”¯ï¼‰</p>
<p><img src="/../../assets/image-20240402192419777.png"></p>
<h3 id="å…·ä½“å®æ–½-1"><a href="#å…·ä½“å®æ–½-1" class="headerlink" title="å…·ä½“å®æ–½"></a>å…·ä½“å®æ–½</h3><h4 id="Step-1-åˆ›å»ºå¹¶å£°æ˜å‡½æ•°"><a href="#Step-1-åˆ›å»ºå¹¶å£°æ˜å‡½æ•°" class="headerlink" title="Step 1: åˆ›å»ºå¹¶å£°æ˜å‡½æ•°"></a>Step 1: åˆ›å»ºå¹¶å£°æ˜å‡½æ•°</h4><p>åœ¨ <code>vm.c</code> ä¸­åˆ›å»º <code>vmprint</code> ï¼Œå’Œä¸€ä¸ªè¾…åŠ©å‡½æ•° <code>vmprint_helper</code><br>è¾…åŠ©å‡½æ•°ç”¨äºæ›´å¥½çš„é€’å½’ï¼Œä¼ é€’å±‚æ•°<br>    <img src="/../../assets/image-20240402202733431.png"></p>
<p>å£°æ˜å‡½æ•°<br><img src="/../../assets/image-20240402194549874.png"></p>
<h4 id="Step-2-å®ç°å…·ä½“å‡½æ•°"><a href="#Step-2-å®ç°å…·ä½“å‡½æ•°" class="headerlink" title="Step 2: å®ç°å…·ä½“å‡½æ•°"></a>Step 2: å®ç°å…·ä½“å‡½æ•°</h4><p><img src="/../../assets/image-20240402202700458.png"></p>
<h4 id="Step-3ï¼šè¾“å‡ºå¯åŠ¨è¿›ç¨‹é¡µè¡¨"><a href="#Step-3ï¼šè¾“å‡ºå¯åŠ¨è¿›ç¨‹é¡µè¡¨" class="headerlink" title="Step 3ï¼šè¾“å‡ºå¯åŠ¨è¿›ç¨‹é¡µè¡¨"></a>Step 3ï¼šè¾“å‡ºå¯åŠ¨è¿›ç¨‹é¡µè¡¨</h4><p>InsertÂ <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code>Â in <code>exec.c</code> just before theÂ <code>return argc</code>, to print the first processâ€™s page table.</p>
<p><img src="/../../assets/image-20240402195905350.png"></p>
<h3 id="è¿è¡Œç»“æœ-1"><a href="#è¿è¡Œç»“æœ-1" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p><img src="/../../assets/image-20240402202638791.png"></p>
<h3 id="æ³¨æ„-1"><a href="#æ³¨æ„-1" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>ç¬¬ä¸€éå†™å®Œçš„æ—¶å€™å‘ç°æ²¡æœ‰åé¢çš„ <code>$</code> è¾“å‡ºäº†ã€‚<br>å‘ç°æ˜¯åœ¨é€’å½’æŸ¥çœ‹çš„æ—¶å€™æŠŠé¡µè¡¨æ¸…é›¶äº†ï¼Œæ²¡æœ‰äº†æ˜ å°„å¯ä¸æ˜¯å•¥éƒ½å¹²ä¸æˆäº†ğŸ¤£ğŸ¤£ğŸ¤£</p>
<p><img src="/../../assets/image-20240402202325205.png"></p>
<h2 id="Detecting-which-pages-have-been-accessed-hard"><a href="#Detecting-which-pages-have-been-accessed-hard" class="headerlink" title="Detecting which pages have been accessed (hard)"></a>Detecting which pages have been accessed (hard)</h2><blockquote>
<p>Your job is to implementÂ pgaccess(), a system call that reports which pages have been accessed. </p>
<p>The system call takes three arguments. </p>
<p>First, it takes the starting virtual address of the first user page to check.<br>Second, it takes the number of pages to check.<br>Finally, it takes a <strong>user address</strong> to a buffer to store the results into a bitmask (a datastructure that uses one bit per page and where the first page corresponds to the least significant bit). </p>
<p>You will receive full credit for this part of the lab if theÂ <code>pgaccess</code>Â test case passes when runningÂ <code>pgtbltest</code>.</p>
</blockquote>
<p>å®Œå–„ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ <code>pgaccess</code> çš„ä»£ç ï¼Œå…¶ç”¨äºæŸ¥çœ‹ä¸€æ®µé¡µè¡¨æœ‰æ²¡æœ‰è¢«ä½¿ç”¨è¿‡ï¼ˆå³ PTE ä¸­çš„ <code>PTE_A</code> ä½æ˜¯å¦ä¸º 1ï¼‰</p>
<ul>
<li>æ¥å—ä¸‰ä¸ªå‚æ•°<ul>
<li>è¦æŸ¥çœ‹çš„é¡µè¡¨é¦–åœ°å€</li>
<li>è¦è¿ç»­æŸ¥å¤šå°‘ä¸ªé¡µè¡¨</li>
<li>ä¸€ä¸ªåœ°å€ï¼Œè¿”å›å€¼å°†æ”¾åˆ°è¿™ä¸ªåœ°å€é‡Œ</li>
</ul>
</li>
</ul>
<h3 id="å‡†å¤‡-1"><a href="#å‡†å¤‡-1" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h3><h4 id="Walk-å‡½æ•°"><a href="#Walk-å‡½æ•°" class="headerlink" title="Walk å‡½æ•°"></a>Walk å‡½æ•°</h4><p>æŸ¥è¯¢è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨æ¡ç›®</p>
<ul>
<li>å‚æ•° 1ï¼šé¡µè¡¨</li>
<li>å‚æ•° 2ï¼šè™šæ‹Ÿåœ°å€</li>
<li>å‚æ•° 3ï¼šæ˜¯å¦åˆ†é…ï¼Œå³å½“æ²¡æŸ¥åˆ°è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨æ¡ç›®æ—¶ï¼Œæ˜¯å¦è¦ä¸ºå…¶åˆ†é…ä¸€æ®µç©ºé—´</li>
</ul>
<figure class="highlight c"><figcaption><span>fold</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return the address of the PTE in page table pagetable</span></span><br><span class="line"><span class="comment">// that corresponds to virtual address va.  If alloc!=0,</span></span><br><span class="line"><span class="comment">// create any required page-table pages.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The risc-v Sv39 scheme has three levels of page-table</span></span><br><span class="line"><span class="comment">// pages. A page-table page contains 512 64-bit PTEs.</span></span><br><span class="line"><span class="comment">// A 64-bit virtual address is split into five fields:</span></span><br><span class="line"><span class="comment">//   39..63 -- must be zero.</span></span><br><span class="line"><span class="comment">//   30..38 -- 9 bits of level-2 index.</span></span><br><span class="line"><span class="comment">//   21..29 -- 9 bits of level-1 index.</span></span><br><span class="line"><span class="comment">//   12..20 -- 9 bits of level-0 index.</span></span><br><span class="line"><span class="comment">//    0..11 -- 12 bits of byte offset within the page.</span></span><br><span class="line"><span class="type">pte_t</span> *</span><br><span class="line"><span class="title function_">walk</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va, <span class="type">int</span> alloc)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (va &gt;= MAXVA)</span><br><span class="line">        panic(<span class="string">&quot;walk&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> level = <span class="number">2</span>; level &gt; <span class="number">0</span>; level--) &#123;</span><br><span class="line">        <span class="type">pte_t</span> *pte = &amp;pagetable[PX(level, va)];</span><br><span class="line">        <span class="keyword">if</span> (*pte &amp; PTE_V) &#123;</span><br><span class="line">            pagetable = (<span class="type">pagetable_t</span>)PTE2PA(*pte);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!alloc || (pagetable = (<span class="type">pde_t</span> *)kalloc()) == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">memset</span>(pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line">            *pte = PA2PTE(pagetable) | PTE_V;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;pagetable[PX(<span class="number">0</span>, va)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="Argint-å’Œ-Argaddr-å‡½æ•°"><a href="#Argint-å’Œ-Argaddr-å‡½æ•°" class="headerlink" title="Argint å’Œ Argaddr å‡½æ•°"></a>Argint å’Œ Argaddr å‡½æ•°</h4><p>ç”¨äºåœ¨å†…æ ¸æ€æ—¶è¯»å–ç”¨æˆ·æ€ä¼ å…¥çš„å‚æ•°ï¼Œå…·ä½“å®ç°ä¼šè°ƒç”¨ <code>argraw</code> æ¥è¯»å–å°†ç”¨æˆ·æ€å¯„å­˜å™¨å­˜åˆ°çš„ <code>trapframe</code>ã€‚</p>
<ul>
<li>å‚æ•° 1ï¼šè¡¨ç¤ºæŸ¥æ‰¾ç¬¬å‡ ä¸ªä¼ å…¥å‚æ•°</li>
<li>å‚æ•° 2ï¼šæ¥å—å‚æ•°åœ°å€</li>
</ul>
<figure class="highlight c"><figcaption><span>fold</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> uint64</span><br><span class="line"><span class="title function_">argraw</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">    <span class="keyword">switch</span> (n) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> p-&gt;trapframe-&gt;a0;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> p-&gt;trapframe-&gt;a1;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> p-&gt;trapframe-&gt;a2;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> p-&gt;trapframe-&gt;a3;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> p-&gt;trapframe-&gt;a4;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> p-&gt;trapframe-&gt;a5;</span><br><span class="line">    &#125;</span><br><span class="line">    panic(<span class="string">&quot;argraw&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fetch the nth 32-bit system call argument.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">argint</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> *ip)</span> &#123;</span><br><span class="line">    *ip = argraw(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retrieve an argument as a pointer.</span></span><br><span class="line"><span class="comment">// Doesn&#x27;t check for legality, since</span></span><br><span class="line"><span class="comment">// copyin/copyout will do that.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">argaddr</span><span class="params">(<span class="type">int</span> n, uint64 *ip)</span> &#123;</span><br><span class="line">    *ip = argraw(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Copyin-å’Œ-Copyout-å‡½æ•°"><a href="#Copyin-å’Œ-Copyout-å‡½æ•°" class="headerlink" title="Copyin å’Œ Copyout å‡½æ•°"></a>Copyin å’Œ Copyout å‡½æ•°</h4><p>ç”¨äºå°†å†…æ ¸æ€çš„æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·æ€ or å°†ç”¨æˆ·æ€çš„æ•°æ®å¤åˆ¶åˆ°å†…æ ¸æ€ã€‚</p>
<p>å‚æ•° 1ï¼šé¡µè¡¨<br>å‚æ•° 2ã€3ï¼šç›®çš„åœ°å€å’Œä¼ è¾“å†…å®¹<br>å‚æ•° 4ï¼šä¼ è¾“å†…å®¹é•¿åº¦</p>
<figure class="highlight c"><figcaption><span>fold</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copy from kernel to user.</span></span><br><span class="line"><span class="comment">// Copy len bytes from src to virtual address dstva in a given page table.</span></span><br><span class="line"><span class="comment">// Return 0 on success, -1 on error.</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">copyout</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 dstva, <span class="type">char</span> *src, uint64 len)</span> &#123;</span><br><span class="line">    uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        va0 = PGROUNDDOWN(dstva);</span><br><span class="line">        pa0 = walkaddr(pagetable, va0);</span><br><span class="line">        <span class="keyword">if</span> (pa0 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        n = PGSIZE - (dstva - va0);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; len)</span><br><span class="line">            n = len;</span><br><span class="line">        memmove((<span class="type">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">        len -= n;</span><br><span class="line">        src += n;</span><br><span class="line">        dstva = va0 + PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy from user to kernel.</span></span><br><span class="line"><span class="comment">// Copy len bytes to dst from virtual address srcva in a given page table.</span></span><br><span class="line"><span class="comment">// Return 0 on success, -1 on error.</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">copyin</span><span class="params">(<span class="type">pagetable_t</span> pagetable, <span class="type">char</span> *dst, uint64 srcva, uint64 len)</span> &#123;</span><br><span class="line">    uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        va0 = PGROUNDDOWN(srcva);</span><br><span class="line">        pa0 = walkaddr(pagetable, va0);</span><br><span class="line">        <span class="keyword">if</span> (pa0 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        n = PGSIZE - (srcva - va0);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; len)</span><br><span class="line">            n = len;</span><br><span class="line">        memmove(dst, (<span class="type">void</span> *)(pa0 + (srcva - va0)), n);</span><br><span class="line"></span><br><span class="line">        len -= n;</span><br><span class="line">        dst += n;</span><br><span class="line">        srcva = va0 + PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="å…·ä½“å®æ–½-2"><a href="#å…·ä½“å®æ–½-2" class="headerlink" title="å…·ä½“å®æ–½"></a>å…·ä½“å®æ–½</h3><h4 id="Step-1ï¼šæ·»åŠ -PTE-A"><a href="#Step-1ï¼šæ·»åŠ -PTE-A" class="headerlink" title="Step 1ï¼šæ·»åŠ  PTE_A"></a>Step 1ï¼šæ·»åŠ  PTE_A</h4><p>åœ¨ <code>riscv.h</code> ä¸­æ·»åŠ  <code>PTE_A</code> </p>
<p><img src="/../../assets/image-20240402213039144.png"></p>
<h4 id="Step-2ï¼šå®Œå–„å†…æ ¸ä»£ç "><a href="#Step-2ï¼šå®Œå–„å†…æ ¸ä»£ç " class="headerlink" title="Step 2ï¼šå®Œå–„å†…æ ¸ä»£ç "></a>Step 2ï¼šå®Œå–„å†…æ ¸ä»£ç </h4><ul>
<li>é€šè¿‡ <code>argint</code> å’Œ <code>argaddr</code> æ¥è·å–ç”¨æˆ·æ€ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</li>
<li>é€šè¿‡ <code>walk</code> æ¥è·å– PTEï¼Œä»è€ŒæŸ¥çœ‹ <code>PTE_A</code> æƒé™ä½</li>
<li>é€šè¿‡è¿”å›ä¸€ä¸ª 32 ä½çš„æ•°æ¥è¡¨ç¤ºï¼Œè¡¨ç¤º 32 ä¸ªé¡µè¡¨æ¯ä¸ªé¡µè¡¨æ˜¯å¦è¢«è®¿é—®è¿‡ã€‚ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå…¶ä¸­çš„æ¯ä¸€ä½ 1&#x2F;0 è¡¨ç¤ºæ˜¯å¦è¢«è®¿é—®è¿‡ã€‚</li>
<li>é€šè¿‡ <code>copyout</code> å°†è¿”å›å€¼æ”¾åˆ°ä¼ å…¥å‚æ•°çš„é‚£ä¸ªåœ°å€ä¸­</li>
</ul>
<figure class="highlight c"><figcaption><span>fold</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="comment">// new</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_pgaccess</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// lab pgtbl: your code here.</span></span><br><span class="line">    uint64 va;</span><br><span class="line">    <span class="type">int</span>    page_num;</span><br><span class="line">    uint64 abits_addr;</span><br><span class="line"></span><br><span class="line">    argaddr(<span class="number">0</span>, &amp;va);</span><br><span class="line">    argint(<span class="number">1</span>, &amp;page_num);</span><br><span class="line">    argaddr(<span class="number">2</span>, &amp;abits_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (page_num &lt; <span class="number">0</span> || page_num &gt; <span class="number">32</span>) &#123;</span><br><span class="line">        panic(<span class="string">&quot;sys_pgaccess: page_num invalid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint32       ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">pte_t</span>       *pte = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; page_num; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((pte = walk(p-&gt;pagetable, va + i * PGSIZE, <span class="number">0</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">            panic(<span class="string">&quot;sys_pgaccess: walk error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*pte &amp; PTE_A) &#123;</span><br><span class="line">            ret |= (<span class="number">1</span> &lt;&lt; i);</span><br><span class="line">            *pte &amp;= (~PTE_A);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copyout(p-&gt;pagetable, abits_addr, (<span class="type">char</span> *)&amp;ret, <span class="keyword">sizeof</span>(ret)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        panic(<span class="string">&quot;sys_pgaccess: copyout error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>


<h3 id="è¿è¡Œç»“æœ-2"><a href="#è¿è¡Œç»“æœ-2" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p><img src="/../../assets/image-20240402215248792.png"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://csdiy.wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/">cs wiki</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19k4y1C7kA/?spm_id_from=333.337.search-card.all.click&vd_source=664d223fe65c6706d11206b7416f5b92">MIT6.S081è¯¾å ‚è§†é¢‘</a><br><a target="_blank" rel="noopener" href="https://github.com/duguosheng/6.S081-All-in-one">6.S081-All-in-one</a><br><a target="_blank" rel="noopener" href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081">MIT6.S081 è§†é¢‘è®°å½•</a><br><a target="_blank" rel="noopener" href="https://xv6.dgs.zone/tranlate_books/book-riscv-rev1/summary.html">BOOK-RISCV-REV1</a></p>
<p><a target="_blank" rel="noopener" href="https://doraemonzzz.com/tags/6-S081/">doraemonzzzâ€™s blog</a><br><a target="_blank" rel="noopener" href="https://blog.miigon.net/">Miigonâ€™s blog</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/weijunji/tag/XV6/">æ˜Ÿé¥è§</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/465640330">xv6 labs æ€»ç»“</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/duile/p/16087757.html">MIT6.S081-Lab3 Pgtbl 2021Fall</a><br><a target="_blank" rel="noopener" href="https://www.chens.life/posts/mit-xv6-lab3/">xv6-labs-2022 Lab3 page tables</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A1%B5%E8%A1%A8/" rel="tag">é¡µè¡¨</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/07/17/hello-world/">Hello World</a><a class="next" href="/2024/03/27/csapp/2024-03-11-%E3%80%90CSAPP%E3%80%91%20ch9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/">ã€CSAPPã€‘ ch9-è™šæ‹Ÿå†…å­˜</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://note.devilran.xyz"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="å…³äº"><img class="nofancybox" src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/OS/CSAPP/">CSAPP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/MIT-6-S081/">MIT 6.S081</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/%E9%A1%B5%E8%A1%A8/" style="font-size: 15px;">é¡µè¡¨</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 15px;">ç³»ç»Ÿè°ƒç”¨</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/07/17/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/03/mit-6-S081-lab/2024-04-03-%E3%80%90MIT%206.S081%E3%80%91%20Lab3-Page%20Tables(2022)/">ã€MIT 6.S081ã€‘ Lab3-Page Tables(2022)</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/27/csapp/2024-03-11-%E3%80%90CSAPP%E3%80%91%20ch9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/">ã€CSAPPã€‘ ch9-è™šæ‹Ÿå†…å­˜</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/23/mit-6-S081-lab/2024-03-23-%E3%80%90MIT%206.S081%E3%80%91%20Lab2-System%20calls/">ã€MIT 6.S081ã€‘ Lab2-System calls</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/07/mit-6-S081-lab/2024-03-07-%E3%80%90MIT%206.S081%E3%80%91%20Lab1-Xv6%20and%20Unix%20utilities/">ã€MIT 6.S081ã€‘ Lab1-Xv6 and Unix utilities</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2024 <a href="/." rel="nofollow">Devil.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>